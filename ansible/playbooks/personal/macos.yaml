---
- name: Install MacOS Packages
  hosts: localhost
  # become: true
  vars:
    upgrade_homebrew_packages: true
    brew_casks:
      - airflow
      - balenaetcher
      - docker
      - firefox
      - google-chrome
      - handbrake
      - home-assistant
      - imageoptim
      - mullvadvpn
      - raspberry-pi-imager
      # - send-to-kindle
      - telegram-desktop
      - visual-studio-code
      - vlc
    brew_formula:
      - ffmpeg
      - flux
      - get_iplayer
      - git
      - helm
      - jq
      - kubectl
      - macvim
      - mutt
      - neofetch
      - nmap
      - rsync
      - sqlite
      - watch
      - wget
      - yt-dlp
      - yq
      - mas


  tasks:

    - name: Ensuring Homebrew Is Installed
      ansible.builtin.stat:
        path: /opt/homebrew/bin/brew
      register: homebrew_check

    # - name: Updating Homebrew
    #   community.general.homebrew:
    #     update_homebrew: true
    #   when: homebrew_check.stat.exists

    - name: Ensure all casks are installed
      community.general.homebrew_cask:
        name: "{{ brew_casks }}"
        state: present
        update_homebrew: true
      register: result
      until: result is successful
      when: homebrew_check.stat.exists

    - name: Ensure all formula are installed
      community.general.homebrew:
        name: "{{ brew_formula }}"
        state: present
        update_homebrew: true
      register: result
      until: result is successful
      when: homebrew_check.stat.exists

    - name: Ensure existing brew are upgraded
      community.general.homebrew:
        upgrade_all: "{{ upgrade_homebrew_packages }}"
      register: result
      until: result is successful
      when: homebrew_check.stat.exists
