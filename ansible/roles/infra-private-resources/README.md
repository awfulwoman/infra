# infra-private-resources

Manages local VM infrastructure using Terraform and libvirt.

## Architecture

**Control Plane**: `dns` host runs Terraform and manages VM lifecycle
**Hypervisor**: `host-storage` runs libvirt and executes VMs

Terraform on dns connects to libvirt on host-storage via SSH.

## Security Model

### Dedicated Service Account

This role creates a **restricted service account** for Terraform → libvirt communication:

- **User**: `libvirt-remote` (system account, UID 1000+)
- **Shell**: `/usr/sbin/nologin` (no interactive login)
- **Groups**: `libvirt` only (no sudo, no other privileges)
- **SSH**: Forced command `/usr/local/bin/libvirt-only` (restricts to libvirt operations only)

### SSH Forced Command

The `/usr/local/bin/libvirt-only` script:
- Whitelists only libvirt-related commands (virsh, socket connections)
- Denies all other SSH commands
- Logs all access attempts to syslog
- Prevents interactive sessions

### Blast Radius Limitation

If control plane (dns) is compromised, attacker gains:
- ✅ Ability to manage VMs via libvirt (create/destroy/modify)
- ❌ No shell access to hypervisor
- ❌ No sudo escalation
- ❌ No access to ZFS directly
- ❌ No access to other services on hypervisor
- ❌ Limited lateral movement capability

### SSH Key Management

**Dedicated key pair** for this service:
- Path: `/home/{{ ansible_user }}/.ssh/libvirt-remote_ed25519`
- Not shared with admin user's personal keys
- Automatically generated by role
- Configured in `~/.ssh/config` with `IdentitiesOnly yes`

### Authorized Keys Configuration

```
restrict,pty,command="/usr/local/bin/libvirt-only" ssh-ed25519 AAAA...
```

- `restrict`: Disables port forwarding, agent forwarding, X11 forwarding
- `pty`: Allows PTY allocation (required for some libvirt operations)
- `command=`: Forces execution through security wrapper

## Requirements

### Control Plane (dns)
- Terraform installed
- `libvirt-clients` package (for qemu+ssh:// transport)
- SSH connectivity to hypervisor

### Hypervisor (host-storage)
- libvirt installed and running (via `virtual-qemu-host` role)
- KVM enabled
- ZFS datasets for VM storage

## Variables

### Hypervisor Connection
```yaml
infra_privateresources_hypervisor_host: "host-storage"
infra_privateresources_hypervisor_user: "libvirt-remote"
infra_privateresources_bridge_interface: "enp2s0"
```

### Storage
```yaml
infra_privateresources_pool_path: "/fastpool/pools/vms"
```

### VM Definitions
```yaml
infra_privateresources_vms:
  - id: example_vm
    name: "vm-example"
    description: "Example VM"
    source_image_url: "https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img"
    source_image_cached: "/slowpool/images/ubuntu/noble-server-cloudimg-amd64.img"
    memory: 2048  # MiB
    vcpus: 2
    disk_size_gb: 50
    ip_address: "192.168.1.100"
    mac_address: "52:54:00:00:01:00"
    graphics: false
```

## Usage

### Apply Infrastructure

```bash
ansible-playbook ansible/playbooks/baremetal/dns/terraform.yaml \
  -e infra_privateresources_tf_apply=true
```

### Debug Mode

```bash
ansible-playbook ansible/playbooks/baremetal/dns/terraform.yaml \
  -e infra_privateresources_debug=true
```

### Manual Terraform

```bash
ssh awful@dns
cd /fastpool/terraform/private-resources
terraform plan
terraform apply
```

Note: SSH config automatically uses correct service account credentials.

## Dependencies

- `virtual-qemu-host`: Must run on hypervisor first
- `system-sshkey`: Should run on control plane to generate base SSH keys

## Files Managed

### Control Plane (dns)
- `/fastpool/terraform/private-resources/` - Terraform configuration
- `~/.ssh/libvirt-remote_ed25519` - Dedicated SSH key
- `~/.ssh/config` - SSH client configuration

### Hypervisor (host-storage)
- `/usr/local/bin/libvirt-only` - Forced command security wrapper
- `/fastpool/pools/vms/` - ZFS datasets for VM storage
- `/slowpool/images/ubuntu/` - Cached cloud images
- `~libvirt-remote/.ssh/authorized_keys` - Restricted SSH access

## Audit Trail

All libvirt SSH connections are logged to syslog:

```bash
sudo grep libvirt-ssh /var/log/syslog
```

## Testing

```bash
# Test SSH connection
ssh awful@dns "ssh host-storage virsh version"

# Verify forced command blocks unauthorized access
ssh awful@dns "ssh host-storage ls /"
# Should fail with "Command not allowed"
```

## Security Considerations

- Service account has minimal privileges (libvirt group only)
- All commands restricted via SSH forced command
- No sudo access for service account
- No shell access to hypervisor filesystem
- Separate SSH keys (not reusing admin credentials)
- Island-hopping attack surface limited to VM management only
