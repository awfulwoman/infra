---
- name: Assert that zfs variable is defined
  ansible.builtin.assert:
    that:
      - zfs is defined
    fail_msg: "The 'zfs' variable must be defined in host_vars to use this role"
    quiet: true

- name: Ensure script directory exists
  become: true
  ansible.builtin.file:
    path: "{{ system_zfs_policy_script_path }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure log directory exists
  become: true
  ansible.builtin.file:
    path: "{{ system_zfs_policy_log_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy ZFS snapshot script
  become: true
  ansible.builtin.template:
    src: zfs-snapshot.py.j2
    dest: "{{ system_zfs_policy_script_path }}/zfs-snapshot"
    owner: root
    group: root
    mode: "0755"
  notify:
    - Reload systemd daemon

- name: Deploy ZFS prune script
  become: true
  ansible.builtin.template:
    src: zfs-prune.py.j2
    dest: "{{ system_zfs_policy_script_path }}/zfs-prune"
    owner: root
    group: root
    mode: "0755"
  notify:
    - Reload systemd daemon

- name: Deploy ZFS snapshot report script
  become: true
  ansible.builtin.template:
    src: zfs-snapshot-report.py.j2
    dest: "{{ system_zfs_policy_script_path }}/zfs-snapshot-report"
    owner: root
    group: root
    mode: "0755"

- name: Add ZFS policy scripts to system-wide PATH
  become: true
  ansible.builtin.copy:
    dest: /etc/profile.d/zfs-policy-path.sh
    content: 'PATH=$PATH:{{ system_zfs_policy_script_path }}'
    owner: root
    group: root
    mode: "0644"

- name: Deploy snapshot services
  become: true
  ansible.builtin.template:
    src: "zfs-snapshot-{{ item }}.service.j2"
    dest: "/etc/systemd/system/zfs-snapshot-{{ item }}.service"
    owner: root
    group: root
    mode: "0644"
  loop:
    - hourly
    - daily
    - monthly
    - yearly
  notify:
    - Reload systemd daemon

- name: Deploy snapshot timers
  become: true
  ansible.builtin.template:
    src: "zfs-snapshot-{{ item }}.timer.j2"
    dest: "/etc/systemd/system/zfs-snapshot-{{ item }}.timer"
    owner: root
    group: root
    mode: "0644"
  loop:
    - hourly
    - daily
    - monthly
    - yearly
  notify:
    - Reload systemd daemon

- name: Deploy prune service
  become: true
  ansible.builtin.template:
    src: zfs-prune.service.j2
    dest: /etc/systemd/system/zfs-prune.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd daemon

- name: Deploy prune timer
  become: true
  ansible.builtin.template:
    src: zfs-prune.timer.j2
    dest: /etc/systemd/system/zfs-prune.timer
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd daemon

# Flush handlers to ensure systemd is reloaded before enabling timers
- name: Flush handlers
  ansible.builtin.meta: flush_handlers

- name: Enable and start snapshot timers
  become: true
  ansible.builtin.systemd_service:
    name: "zfs-snapshot-{{ item }}.timer"
    state: started
    enabled: true
    daemon_reload: false
  loop:
    - hourly
    - daily
    - monthly
    - yearly
  when: system_zfs_policy_snapshots_enable

- name: Disable and stop snapshot timers
  become: true
  ansible.builtin.systemd_service:
    name: "zfs-snapshot-{{ item }}.timer"
    state: stopped
    enabled: false
    daemon_reload: false
  loop:
    - hourly
    - daily
    - monthly
    - yearly
  when: not system_zfs_policy_snapshots_enable

- name: Enable and start prune timer
  become: true
  ansible.builtin.systemd_service:
    name: zfs-prune.timer
    state: started
    enabled: true
    daemon_reload: false
  when: system_zfs_policy_snapshots_enable

- name: Disable and stop prune timer
  become: true
  ansible.builtin.systemd_service:
    name: zfs-prune.timer
    state: stopped
    enabled: false
    daemon_reload: false
  when: not system_zfs_policy_snapshots_enable
