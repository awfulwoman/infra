- name: Install BIND packages
  become: true
  ansible.builtin.apt:
    name:
      - bind9
      - bind9-dnsutils
      - bind9-doc
      - bind9-host
      - bind9-libs
      - bind9-utils
    state: present

- name: Ensure zones dir exists
  become: true
  ansible.builtin.file:
    dest: /etc/bind/zones
    state: directory
    owner: root
    group: bind
    mode: "0755"

- name: Ensure named options exist
  become: true
  ansible.builtin.template:
    src: named.conf.options
    dest: /etc/bind/named.conf.options
    owner: root
    group: bind
    mode: "0644"
    validate: named-checkconf %s

- name: Ensure main zone file exists
  become: true
  ansible.builtin.template:
    src: db.zone
    dest: "/etc/bind/zones/db.{{ bind_domain }}.zone"
    owner: root
    group: bind
    mode: "0644"
    validate: named-checkzone {{ bind_domain }} %s
  notify:
    - Restart named

- name: Ensure reverse zone file exists
  become: true
  ansible.builtin.template:
    src: db.reverse.zone
    dest: "/etc/bind/zones/db.{{ bind_domain }}.reverse.zone"
    owner: root
    group: bind
    mode: "0644"
    validate: "named-checkzone {{ bind_iprange_reversed | join('.') }}.in-addr.arpa %s"
  notify:
    - Restart named

# - name: Open DNS port in firewall
#   become: true
#   community.general.ufw:
#     rule: allow
#     port: 53
#     proto: tcp
#     state: enabled

# - name: Disable Ubuntu Host's caching DNS resolver on port 53
#   become: true
#   ansible.builtin.lineinfile:
#     dest: /etc/systemd/resolved.conf
#     line: "DNSStubListener=no"
#     regexp: "#?DNSStubListener=yes"
#     state: present

- name: Start named services
  become: true
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
    enabled: true
  loop:
    - named
