- name: Install BIND
  become: true
  ansible.builtin.apt:
    name:
      - bind9
      - bind9-dnsutils
      - bind9-doc
      - bind9-host
      - bind9-libs
      - bind9-utils
    state: present

- name: Ensure zones dir exists
  become: true
  ansible.builtin.file:
    dest: /etc/bind/zones
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0755"

- name: Copy named.conf.options
  become: true
  ansible.builtin.template:
    src: named.conf.options
    dest: /etc/bind/named.conf.options
    # owner: "{{ ansible_user }}" # root
    # group: "{{ ansible_user }}" # bind
    owner: root
    group: bind
    mode: "0644"

- name: Ensure zone file exists
  become: true
  ansible.builtin.template:
    src: db.zone
    dest: "/etc/bind/zones/db.{{ bind_domain }}.zone"
    # owner: "{{ ansible_user }}" # root
    # group: "{{ ansible_user }}" # bind
    owner: root
    group: bind
    mode: "0644"

- name: Ensure reverse zone file exists
  become: true
  ansible.builtin.template:
    src: db.reverse.zone
    dest: "/etc/bind/zones/db.{{ bind_domain }}.reverse.zone"
    # owner: "{{ ansible_user }}" # root
    # group: "{{ ansible_user }}" # bind
    owner: root
    group: bind
    mode: "0644"

# - name: Open DNS port in firewall
#   become: true
#   community.general.ufw:
#     rule: allow
#     port: 53
#     proto: tcp
#     state: enabled

- name: Start BIND service
  become: true
  ansible.builtin.systemd:
    name: named
    state: started
    enabled: true
