# code: language=ansible
name: "{{ composition_name }}"
services:
  microphone:
    image: "rhasspy/wyoming-mic-external"
    ports:
      - "10600:10600"
    devices:
      - /dev/snd:/dev/snd
    group_add:
      - audio
    command:
      - "--device"
      - "sysdefault"
      - "--debug"
    networks:
      - "{{ default_docker_network }}"
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 10600 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  playback:
    image: "rhasspy/wyoming-snd-external"
    ports:
      - "10601:10601"
    devices:
      - /dev/snd:/dev/snd
    group_add:
      - audio
    command:
      - "--device"
      - "sysdefault"
      - "--debug"
    networks:
      - "{{ default_docker_network }}"
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 10601 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  satellite:
    image: "rhasspy/wyoming-satellite"
    ports:
      - "10700:10700"
    command:
      - "--name"
      - "my satellite"
      - "--mic-uri"
      - "tcp://microphone:10600"
      - "--snd-uri"
      - "tcp://playback:10601"
      - "--debug"
    networks:
      - "{{ default_docker_network }}"
    depends_on:
      microphone:
        condition: service_healthy
      playback:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 10700 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  "{{ default_docker_network }}":
    external: true
