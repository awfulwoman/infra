- name: Ensure supporting packages are installed
  become: true
  ansible.builtin.package:
    name:
      - python3-dnspython
    state: present

- name: Ensure working dir exists
  become: true
  ansible.builtin.file:
    dest: "{{ infra_certbot_working_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0755"

- name: Ensure secure directories exist
  become: true
  ansible.builtin.file:
    dest: "{{ dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0700"
  loop_control:
    loop_var: dir
  loop:
    - "{{ infra_certbot_le_private_key_dir }}"
    - "{{ infra_certbot_csr_private_key_dir }}"
    - "{{ infra_certbot_csr_dir }}"

- name: Ensure cert directories exist
  become: true
  ansible.builtin.file:
    dest: "{{ dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0744"
  loop_control:
    loop_var: dir
  loop:
    - "{{ infra_certbot_cert_dir }}"
    # - "{{ infra_certbot_fullchain_dir }}"
    # - "{{ infra_certbot_chain_dir }}"
