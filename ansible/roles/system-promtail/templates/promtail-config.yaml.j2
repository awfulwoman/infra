server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: {{ promtail_positions_file }}

clients:
  - url: {{ promtail_loki_url }}

scrape_configs:
  # Docker container logs via Docker SD
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s

    relabel_configs:
      # Add host label
      - source_labels: ['__meta_docker_container_id']
        target_label: host
        replacement: {{ inventory_hostname }}

      # Container name without leading slash
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: container_name

      # Container ID (short form)
      - source_labels: ['__meta_docker_container_id']
        regex: '([a-f0-9]{12}).*'
        target_label: container_id

      # Extract composition from container label (docker-compose project)
      - source_labels: ['__meta_docker_container_label_com_docker_compose_project']
        target_label: composition

      # Extract service name from docker-compose
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: service

      # Set log path
      - source_labels: ['__meta_docker_container_id']
        target_label: __path__
        replacement: {{ promtail_docker_log_path }}/$1/*-json.log

    pipeline_stages:
      # Parse JSON log format
      - json:
          expressions:
            output: log
            stream: stream

      # Extract labels
      - labels:
          stream:

      # Output the log line
      - output:
          source: output

{% if promtail_journald_enabled %}
  # System journald logs
  - job_name: systemd
    journal:
      max_age: {{ promtail_journald_max_age }}
      labels:
        job: systemd
        host: {{ inventory_hostname }}

    pipeline_stages:
      # Extract systemd unit
      - json:
          expressions:
            unit: _SYSTEMD_UNIT
            priority: PRIORITY
            message: MESSAGE

      # Add labels
      - labels:
          unit:
          priority:

      # Output message
      - output:
          source: message
{% endif %}
