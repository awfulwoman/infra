- name: Healthchecks block
  when: monitoring_healthchecksio
  block:
    - name: Ensure that Healthchecks.io check is present
      community.healthchecksio.checks:
        state: present
        api_key: "{{ vault_healthchecks_rw_apikey }}"
        name: "{{ monitoring_healthchecksio_name }}"
        unique: ["name"]
        tags:
          - autogenerated
          - "{{ host_type }}"
          - "{{ ansible_hostname }}"
        schedule: "0 8 * * *"
        tz: UTC
      register: healthchecksio_check

    - name: Debug healthchecksio_check
      ansible.builtin.debug:
        var: healthchecksio_check.uuid
      when: healthchecksio_check is defined and monitoring_healthchecksio_debug | bool

    - name: Ping Healthchecks.io check
      community.healthchecksio.ping:
        state: present
        api_key: "{{ vault_healthchecks_rw_apikey }}"
        signal: success
        uuid: "{{ healthchecksio_check.uuid }}"
      when: healthchecksio_check is defined and healthchecksio_check.uuid is defined and healthchecksio_check.uuid is not false
      register: healthchecksio_ping
      changed_when: false

    - name: Debug healthchecksio_ping
      ansible.builtin.debug:
        var: healthchecksio_ping
      when: healthchecksio_ping is defined and monitoring_healthchecksio_debug | bool

  rescue:
    - name: All is good if the first task failed
      when: ansible_failed_task.name == 'Ensure that Healthchecks.io check is present'
      ansible.builtin.debug:
        msg: "Healthchecks.io module couldn't run"
