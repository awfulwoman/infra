# - name: Ensure domains exist
#   community.digitalocean.digital_ocean_domain:
#     state: present
#     name: "{{ item.domain }}"
#     oauth_token: "{{ vault_digitalocean_full_access_token }}"
#     project_name: "{{ item.project }}"
#   loop: "{{ infra_domains_domains }}"

# - name: Loop over each domains and deal with records
#   ansible.builtin.include_tasks:
#     file: records.yaml
#   loop: "{{ infra_domains_domains }}"
#   loop_control:
#     loop_var: item
#     extended: true

- name: Add repo using key from URL (Ubuntu)
  become: true
  ansible.builtin.deb822_repository:
    name: terraform
    types: deb
    uris: "https://apt.releases.hashicorp.com"
    suites: "{{ ansible_distribution_release }}"
    components: main
    architectures: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' if ansible_architecture == 'aarch64' else ansible_architecture }}"
    signed_by: "https://apt.releases.hashicorp.com/gpg"

- name: Ensure installation dependencies exist
  become: true
  ansible.builtin.apt:
    update_cache: true
    name:
      - terraform

- name: Basic deploy of a service
  community.general.terraform:
    force_init: true
    project_path: /opt/infra/terraform/personal-domains
    state: present
