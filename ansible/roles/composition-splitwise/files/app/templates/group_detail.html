{% extends "base.html" %}

{% block title %}{{ group.name }} - Splitwise{% endblock %}

{% block content %}
<div class="page-header">
    <h2>{{ group.name }}</h2>
    <div>
        <button class="btn btn-primary" onclick="showAddTransactionModal()">Add Expense</button>
        <button class="btn btn-secondary" onclick="showRecordPaymentModal()">Record Payment</button>
    </div>
</div>

<!-- Balances Section -->
<div class="balances-section">
    <h3>Balances</h3>
    <div class="balances-grid">
        {% for member in members %}
        <div class="balance-card {% if member.balance > 0 %}positive{% elif member.balance < 0 %}negative{% endif %}">
            <div class="member-name">{{ member.display_name }}</div>
            <div class="balance-amount">
                {% if member.balance > 0 %}
                    +€{{ "%.2f"|format(member.balance) }}
                {% elif member.balance < 0 %}
                    -€{{ "%.2f"|format(-member.balance) }}
                {% else %}
                    €0.00
                {% endif %}
            </div>
            <div class="balance-status">
                {% if member.balance > 0 %}
                    is owed
                {% elif member.balance < 0 %}
                    owes
                {% else %}
                    settled up
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Transactions Section -->
<div class="transactions-section">
    <h3>Recent Transactions</h3>
    {% if transactions %}
        <div class="transactions-list">
            {% for tx in transactions %}
            <div class="transaction-card">
                <div class="transaction-header">
                    <span class="transaction-description">{{ tx.description }}</span>
                    <span class="transaction-amount">€{{ "%.2f"|format(tx.amount) }}</span>
                </div>
                <div class="transaction-meta">
                    {% if tx.split_type == "payment" %}
                        Payment from
                        {% for member in members %}
                            {% if member.id == tx.payer_id %}{{ member.display_name }}{% endif %}
                        {% endfor %}
                        to
                        {% for member in members %}
                            {% if member.id == tx.recipient_id %}{{ member.display_name }}{% endif %}
                        {% endfor %}
                    {% else %}
                        Paid by
                        {% for member in members %}
                            {% if member.id == tx.payer_id %}{{ member.display_name }}{% endif %}
                        {% endfor %}
                        • Split {{ members|length }} ways
                    {% endif %}
                </div>
                <div class="transaction-actions">
                    <button class="btn-link" onclick="deleteTransaction('{{ tx.id }}')">Delete</button>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="empty-state">No transactions yet. Add an expense to get started!</p>
    {% endif %}
</div>

<!-- Add Transaction Modal -->
<div id="addTransactionModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Add Expense</h3>
        <form id="addTransactionForm">
            <div class="form-group">
                <label for="description">Description</label>
                <input type="text" id="description" name="description" required>
            </div>
            <div class="form-group">
                <label for="amount">Amount (€)</label>
                <input type="number" id="amount" name="amount" step="0.01" min="0.01" required>
            </div>
            <div class="form-group">
                <label for="payer_id">Paid by</label>
                <select id="payer_id" name="payer_id" required>
                    {% for member in members %}
                    <option value="{{ member.id }}" {% if member.id == current_user.id %}selected{% endif %}>
                        {{ member.display_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="hideAddTransactionModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Expense</button>
            </div>
            <div id="transaction-error-message" class="error-message" style="display: none;"></div>
        </form>
    </div>
</div>

<!-- Record Payment Modal -->
<div id="recordPaymentModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Record Payment</h3>
        <form id="recordPaymentForm">
            <div class="form-group">
                <label for="payment_payer">From (who paid)</label>
                <select id="payment_payer" name="payer_id" required>
                    {% for member in members %}
                    <option value="{{ member.id }}" {% if member.id == current_user.id %}selected{% endif %}>
                        {{ member.display_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="payment_recipient">To (who received)</label>
                <select id="payment_recipient" name="recipient_id" required>
                    {% for member in members %}
                    <option value="{{ member.id }}">
                        {{ member.display_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="payment_amount">Amount (€)</label>
                <input type="number" id="payment_amount" name="amount" step="0.01" min="0.01" required>
            </div>
            <div class="form-group">
                <label for="payment_description">Description (optional)</label>
                <input type="text" id="payment_description" name="description" placeholder="Payment">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="hideRecordPaymentModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Record Payment</button>
            </div>
            <div id="payment-error-message" class="error-message" style="display: none;"></div>
        </form>
    </div>
</div>

<script>
const GROUP_ID = '{{ group.id }}';
</script>
{% endblock %}
