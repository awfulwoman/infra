- name: Ensure BIND packages are installed
  become: true
  ansible.builtin.apt:
    name:
      - bind9
      - bind9-dnsutils
      - bind9-doc
      - bind9-host
      - bind9-libs
      - bind9-utils
    state: present

- name: Ensure zones dir exists
  become: true
  ansible.builtin.file:
    dest: /etc/bind/zones
    state: directory
    owner: root
    group: bind
    mode: "0755"

- name: Ensure key file exist
  become: true
  ansible.builtin.template:
    src: keys.conf
    dest: /etc/bind/keys.conf
    owner: root
    group: bind
    mode: "0644"

- name: Ensure config file exist
  become: true
  ansible.builtin.template:
    src: named.conf.options
    dest: /etc/bind/named.conf.options
    owner: root
    group: bind
    mode: "0644"
    validate: named-checkconf %s

- name: Check for zone changes
  become: true
  ansible.builtin.template:
    src: db.zone
    dest: "/etc/bind/zones/db.{{ bind_domain }}.zone"
    owner: root
    group: bind
    mode: "0644"
  register: zone_check

- name: Check for reverse zone changes
  become: true
  ansible.builtin.template:
    src: db.zone
    dest: "/etc/bind/zones/db.{{ bind_domain }}.reverse.zone"
    owner: root
    group: bind
    mode: "0644"
  register: reverse_zone_check

- name: Ensure zone file exists
  become: true
  ansible.builtin.template:
    src: db.zone
    dest: "/etc/bind/zones/db.{{ bind_domain }}.zone"
    owner: root
    group: bind
    mode: "0644"
    validate: named-checkzone {{ bind_domain }} %s
  when: zone_check.changed
  notify:
    - Restart named

- name: Ensure reverse zone file exists
  become: true
  ansible.builtin.template:
    src: db.reverse.zone
    dest: "/etc/bind/zones/db.{{ bind_domain }}.reverse.zone"
    owner: root
    group: bind
    mode: "0644"
    validate: "named-checkzone {{ bind_iprange_reversed }}.in-addr.arpa %s"
  when: reverse_zone_check.changed
  notify:
    - Restart named

- name: Replace serial in zone file if changed
  become: true
  ansible.builtin.lineinfile:
    path: "/etc/bind/zones/db.{{ bind_domain }}.zone"
    regexp: "^  1234567890 ; Serial"
    line: "  {{ now(utc=true, fmt='%y%m%d%H%M') }} ; Serial"
  when: zone_check.changed
  notify:
    - Restart named

- name: Replace serial in reverse zone file if changed
  become: true
  ansible.builtin.lineinfile:
    path: "/etc/bind/zones/db.{{ bind_domain }}.reverse.zone"
    regexp: "^  1234567890 ; Serial"
    line: "  {{ now(utc=true, fmt='%y%m%d%H%M') }} ; Serial"
  when: reverse_zone_check.changed
  notify:
    - Restart named

- name: Ensure services are started and enabled
  become: true
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
    enabled: true
  loop:
    - named
