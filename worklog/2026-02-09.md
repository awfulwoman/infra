# 2026-02-09

## Session Overview

Implemented automated GitHub SSH key synchronization for disaster recovery (GH #157), researched Tailscale replacement options and created comprehensive plan (GH #75), and configured Claude Code TTS hook for spoken responses.

## What Was Done

### 1. GitHub SSH Key Sync Implementation
- Created `system-github-ssh-keys` role for periodic key fetching from GitHub
- Deployed cron-based approach (runs 8 AM & 6 PM daily)
- Integrated into `bootstrap-ubuntu-server` role
- Deployed to 5 reachable hosts: host-storage, host-homeassistant, belinda, dns, vm-awfulwoman-hetzner
- Script uses markers (`BEGIN/END GITHUB KEYS`) to safely manage keys
- Tested successfully on host-storage

### 2. Tailscale Replacement Research
- Analyzed 4 alternatives for replacing Tailscale:
  1. **WireGuard + VPS Relay** - Hub-spoke, simple but single point of failure
  2. **Nebula** - Slack's mesh network, uses Noise protocol (not WireGuard)
  3. **Headscale** - Self-hosted Tailscale control server, uses WireGuard
  4. **Innernet** - CIDR tree-based organization, pure WireGuard
- Created comprehensive plan document in `plans/tailscale-replacement.md`
- Recommended: **Headscale** (6-8h implementation, WireGuard-based, familiar UX)
- Alternative: **Innernet** for CIDR-based network organization

### 3. Claude Code Customization
- Configured statusLine to show model name + git branch
- Implemented TTS (text-to-speech) hook using Stop event
- Created `/Users/charlie/.claude/hooks/say-response.sh` to speak responses via macOS `say`
- Added TTS-friendly ending requirement to `~/.claude/CLAUDE.md`
- Hook extracts last assistant message from transcript JSONL, cleans markdown, pipes to `say`

## Key Decisions

### SSH Key Sync: Cron vs Systemd Timer
**Decision**: Cron job (Option 2)
**Rationale**: Simpler than systemd timer, fits existing patterns in codebase (other roles use cron), sufficient for disaster recovery use case

### Schedule: Twice Daily
**Decision**: 8 AM & 6 PM (modified from default 3:15 AM)
**Rationale**: User preference for checking keys during active hours

### Tailscale Replacement: Headscale Recommended
**Decision**: Recommend Headscale over other options
**Rationale**:
- Fastest implementation (6-8h vs 10-19h)
- Uses WireGuard (issue requirement)
- Familiar Tailscale UX
- Self-hosted removes vendor lock-in
- Can fallback to Tailscale if needed

### TTS Hook: Stop Event
**Decision**: Use Stop hook with transcript parsing
**Rationale**: Only hook that fires after assistant responses, provides access to full conversation transcript

## Files Changed

### Created
- `ansible/roles/system-github-ssh-keys/defaults/main.yaml` - Config vars
- `ansible/roles/system-github-ssh-keys/tasks/main.yaml` - Ansible tasks
- `ansible/roles/system-github-ssh-keys/templates/update-github-ssh-keys.sh` - Update script
- `ansible/roles/system-github-ssh-keys/README.md` - Documentation
- `plans/tailscale-replacement.md` - Comprehensive replacement plan
- `/Users/charlie/.claude/hooks/say-response.sh` - TTS hook script

### Modified
- `ansible/roles/bootstrap-ubuntu-server/tasks/main.yaml` - Replaced inline key fetch with role
- `/Users/charlie/.claude/CLAUDE.md` - Added TTS-friendly ending requirement
- `/Users/charlie/.claude/settings.json` - Added Stop hook, configured statusLine

## Current State

### GitHub SSH Keys (GH #157)
- ✅ Implemented and deployed
- ✅ Tested successfully
- ✅ Committed to main (commit: 0c70c7a0)
- ✅ Pushed to origin
- ✅ Issue closed

**Unreachable hosts** will receive role automatically when:
- They come online and playbooks run
- VMs accept host keys
- Initial bootstrap occurs

### Tailscale Replacement (GH #75)
- ✅ Research complete
- ✅ Plan documented
- ⏸️ Awaiting implementation decision
- ⏸️ Issue remains open

### Claude Code Customization
- ✅ StatusLine configured
- ✅ TTS hook working
- ✅ Global instructions updated

## Next Steps

### For GitHub SSH Keys
1. Monitor deployed hosts for key sync (check cron logs after 8 AM/6 PM)
2. Deploy to remaining hosts when they become reachable
3. Optional: Clean up duplicate old keys in authorized_keys

### For Tailscale Replacement
1. **Decision required**: Proceed with Headscale implementation?
2. If yes, answer open questions in plan:
   - ACL granularity level?
   - Run own DERP relay or use embedded?
   - Critical monitoring metrics?
   - Backup frequency for Headscale DB?
   - Need redundant Headscale server?
   - Parallel run duration before cutover?
3. Begin Phase 1: Headscale server setup (2-3 hours)
4. Or: Defer implementation to future session

### For Claude Code
- Optional: Customize TTS voice/rate in say-response.sh
- Optional: Add voice notification for specific events (errors, completions)

## Notes

### SSH Key Sync Implementation
- Script runs as root, modifies user authorized_keys
- Markers prevent conflicts with existing keys
- Old inline keys remain but harmless (can clean manually)
- GitHub username: awfulwoman (configurable in defaults)

### Tailscale Replacement Plan
- Comprehensive 4-option analysis with comparison matrix
- CGNAT is main blocker for plain WireGuard
- vm-awfulwoman-hetzner ideal for hosting coordination server (public IP: 188.245.37.81)
- ~13 infrastructure hosts = good size for any solution
- Migration strategy: parallel run with Tailscale for 2-4 weeks

### TTS Hook Details
- Runs in background (non-blocking)
- Truncates to 500 chars
- Strips markdown for better speech
- Infinite loop protection via `stop_hook_active` check
- Works by reading transcript JSONL file path from Stop hook input

### Unresolved Questions (Tailscale Replacement)
1. ACL granularity approach?
2. DERP relay strategy?
3. Critical monitoring metrics?
4. Backup frequency for Headscale DB?
5. Need redundant Headscale server?
6. Parallel run duration before cutover?
7. Runbook detail level?

---

## GitHub Issues

No new issues identified during this session.
