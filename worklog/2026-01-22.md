# 2026-01-22

## Session Overview
Major work day configuring Belinda as ZFS backup server and deploying VictoriaMetrics for centralized ZFS monitoring across all infrastructure hosts.

## What Was Done

- **Configured Belinda as ZFS backup server**
  - Added Belinda (Raspberry Pi 5 with Radxa Penta HAT) to Ansible inventory
  - Created ZFS pool with mirrored 2TB drives
  - Set up backup dataset at `slowpool/backups/raw`
  - Configured backup scripts with custom dataset path
  - Disabled offsite replication initially (bandwidth limit: 3M configured for future)
  - Added PCIe gen 3 support for Penta SATA HAT

- **Implemented VictoriaMetrics for centralized ZFS monitoring** (GH #140 Phase 3)
  - Created `composition-victoriametrics` role with Prometheus scraper config
  - Scrapes 5 zfs-api endpoints every 60s over HTTPS
  - 1-year metric retention with efficient compression
  - Deployed to host-storage with web UI accessible at {{ vault_personal_domain }}
  - Monitors: host-storage, host-homeassistant, dns, host-backups, host-albion
  - Collects pool capacity, dataset usage, and snapshot compliance metrics

- **Enhanced zfs-api with native Prometheus metrics** (GH #140 Phase 2)
  - Added `/metrics` endpoint exposing 12 ZFS metric types
  - Pool metrics: health, capacity, size, allocation, fragmentation
  - Dataset metrics: used, available, referenced space
  - Snapshot metrics: count, retention targets, compliance percentages
  - Added `prometheus-client==0.21.0` dependency
  - Metrics labeled with hostname, pool, dataset, policy, and interval
  - Removed need for separate Prometheus exporter container

- **Refactored ZFS terminology throughout codebase**
  - Renamed `importance` → `policy` for clarity
  - Updated filter: `zfs_datasets_with_importance` → `zfs_datasets_with_policy`
  - Changed config key: `importance: critical` → `policy: critical`
  - Rationale: "policy" better reflects semantic meaning (snapshot/replication behavior)
  - Updated all variables, parameters, function names, and documentation

- **Documented ZFS policy inheritance features**
  - Added comprehensive docs for `children_inherit_policy` (config-time inheritance)
  - Documented `snapshots_discover_children` (runtime discovery for Docker volumes)
  - Renamed variables for clarity:
    - `inherit_policy` → `children_inherit_policy`
    - `discover_children` → `snapshots_discover_children`
  - Added practical examples from dns and host-storage hosts
  - Enhanced system-zfs-policy README with use cases and troubleshooting

- **Improved ZFS backup scripts**
  - Added per-host lockfile support to `zfs-pull-backups`
  - Host-specific lockfiles enable parallel pulls from different hosts
  - PID-based locking with automatic stale lock cleanup
  - Signal handlers for graceful cleanup (SIGTERM/SIGINT/SIGHUP)
  - Added Python virtual environment setup at `/opt/zfsbackup`
  - Ensures isolated environment with proper dependencies

- **Infrastructure updates**
  - Removed vm-awfulwoman (DigitalOcean) from inventory
  - Kept vm-awfulwoman-hetzner as active instance
  - Changed host-homeassistant ansible_host to use hostname instead of IP
  - Added `build: always` to compositions role for reliable container rebuilds
  - Added `no_cache: true` to zfs-api Dockerfile for fresh builds

## Key Decisions

1. **Deploy VictoriaMetrics on host-storage** instead of separate monitoring host
   - Reason: Centralize with existing metrics infrastructure
   - Trade-off: Storage host does double duty, but has capacity

2. **Use native Prometheus metrics in zfs-api** instead of separate exporter
   - Reason: Simpler architecture, same port as JSON API
   - Impact: One less container per host, easier deployment

3. **Rename "importance" to "policy"** across entire codebase
   - Reason: Better semantic alignment with what it controls
   - Impact: Breaking change for configs, but more intuitive long-term

4. **Per-host lockfiles for backup pulls**
   - Reason: Allow parallel pulls from different hosts safely
   - Impact: Better resource utilization, faster overall backup completion

## Files Changed

Major file changes across multiple areas:

**ZFS API:**
- `ansible/roles/composition-zfs-api/files/app/metrics.py` (new)
- `ansible/roles/composition-zfs-api/files/requirements.txt`
- `ansible/roles/composition-zfs-api/templates/Dockerfile.j2`

**VictoriaMetrics:**
- `ansible/roles/composition-victoriametrics/` (new role)
- `ansible/playbooks/baremetal/host-storage/victoriametrics.yaml` (new)

**Belinda Configuration:**
- `ansible/inventory/host_vars/belinda/core.yaml`
- `ansible/inventory/host_vars/belinda/zfs.yaml` (new)
- `ansible/playbooks/baremetal/belinda/` (new directory)

**ZFS Backup Scripts:**
- `ansible/roles/backups-zfs-server/templates/zfs-pull-backups.py`
- `ansible/roles/backups-zfs-server/tasks/main.yaml`

**Documentation:**
- `docs/zfs.md`
- `ansible/roles/system-zfs-policy/README.md`
- `ansible/plugins/filters/zfs_datasets.py`

**Renamed throughout:**
- All references to `importance` → `policy`
- All references to `inherit_policy` → `children_inherit_policy`
- All references to `discover_children` → `snapshots_discover_children`

## Current State

- ✅ Belinda fully configured as ZFS backup server
- ✅ VictoriaMetrics deployed and collecting metrics from 5 hosts
- ✅ zfs-api exposing Prometheus metrics on all hosts
- ✅ ZFS policy terminology refactored consistently
- ✅ Enhanced backup scripts with lockfiles and venv support
- ✅ Comprehensive documentation for policy inheritance
- ⚠️ Initial backup pulls not yet run (to be done in next session)
- ⚠️ Offsite replication disabled (to be enabled later)

## Next Steps

1. **Run initial backup pulls to Belinda** from all source hosts
   - host-storage (primary backup source)
   - host-homeassistant
   - dns

2. **Verify VictoriaMetrics data collection**
   - Check that all 5 hosts are reporting metrics
   - Validate snapshot compliance calculations
   - Test PromQL queries for common monitoring scenarios

3. **Set up backup cronjobs** on Belinda
   - Configure automated pull schedules
   - Test lockfile behavior with concurrent jobs

4. **Enable offsite replication** when ready
   - Configure push to host-albion
   - Test bandwidth limiting

5. **Create Grafana dashboards** for ZFS metrics
   - Pool health and capacity
   - Dataset growth trends
   - Snapshot compliance tracking

## Notes

- **VictoriaMetrics vs Prometheus**: Chose VictoriaMetrics for better compression and long-term storage efficiency (1 year retention)

- **Belinda Hardware**: Raspberry Pi 5 with Radxa Penta SATA HAT, PCIe gen 3 enabled for better disk performance

- **Policy Terminology**: The rename from "importance" to "policy" affects all host configs but reads much more naturally

- **Lockfile Pattern**: Both push and pull scripts now use same lockfile approach for consistency

- **Virtual Environment**: Scripts require venv at `/opt/zfsbackup` - must exist before scripts run

- **Metrics Endpoint**: zfs-api now serves both JSON API and Prometheus metrics on same port, simplifying architecture

## Commits

- `b221afd9` - feat: add native Prometheus metrics to zfs-api
- `0a4dbd1d` - chore: use hostname for host-homeassistant ansible_host
- `31507dfe` - Update host-backups zfs config
- `ce9a8460` - feat: add VictoriaMetrics for centralized ZFS monitoring
- `10e1163b` - chore: Add zfs composition to zfs roles
- `728b6619` - chore: Add common compositions to host-backups
- `f3d0baf0` - fix: Update victoriametriccs to use correct storage path
- `d443cd8b` - Update belinda with ZFS
- `a03a7058` - fix: Add Belinda to Ansible groups
- `41b260e4` - fix: Upgrade Pentahat to use PCIe gen 3
- `b27813e7` - chore: add info link
- `878a1026` - fix: add basics to ZFS infra playbook
- `60af7261` - fix: Add compositions to Belinda
- `23110452` - feat: add per-host lockfile support to zfs-pull-backups
- `9333f655` - feat: add Python virtual environment setup for ZFS backup scripts
- `255cd224` - feat: configure Belinda as ZFS backup server
- `d98ad924` - docs: document ZFS policy inheritance and child discovery features
- `39df39ab` - refactor: rename ZFS 'importance' to 'policy' throughout codebase
- `f1ba2192` - chore: remove vm-awfulwoman host configuration
