# 2026-01-23

## Session Overview
Fixed ZFS backup script to support encrypted backups by allowing proper encryption inheritance from parent datasets when receiving unencrypted streams.

## What Was Done

- **Debugged ZFS backup failure** on belinda for `slowpool/shared/metrics/zfs` dataset
  - Error: "cannot receive new filesystem stream: zfs receive -F cannot be used to destroy an encrypted filesystem or overwrite an unencrypted one with an encrypted one"
  - Root cause: Pre-created backup datasets inherited encryption from `slowpool/backups/raw`, then `-F` flag on initial receive attempted to overwrite with unencrypted stream

- **Implemented parent dataset auto-creation** in backup script
  - Added `ensure_parent_datasets_exist()` function to `zfs-pull-backups.py`
  - Creates missing parent datasets with proper properties before receiving snapshots
  - Prevents "dataset does not exist" errors for new backup sources

- **Fixed encryption handling** for ZFS receive operations
  - Removed `encryption=off` from parent dataset creation (was preventing encrypted backups)
  - Removed `-F` flag from initial `zfs receive` - allows proper encryption inheritance
  - Only use `-F` for incremental receives after dataset exists
  - Removed Ansible task that pre-created backup datasets (was causing encryption conflicts)

- **Improved backup script logging**
  - Enhanced log messages to include host/dataset context
  - Promoted snapshot range info from debug to info level
  - Better visibility for operators without `--debug` flag

- **Researched ZFS encryption behavior**
  - Confirmed ZFS CAN receive unencrypted streams into encrypted datasets via inheritance
  - Key insight: `-F` flag during initial receive causes the encryption mismatch error
  - Sources: OpenZFS GitHub issues, FreeBSD forums, Practical ZFS discussions

## Key Decisions

1. **Let backup script create datasets dynamically** instead of Ansible pre-creating them
   - Reason: Script can handle encryption correctly based on parent inheritance
   - Trade-off: Datasets created at runtime vs provision time, but more flexible

2. **Use `-F` only for incremental receives** not initial receives
   - Reason: Initial receive doesn't need force flag when dataset doesn't exist
   - Impact: Allows proper encryption inheritance from parent dataset

3. **Removed `encryption=off` from parent creation**
   - Reason: Was preventing encrypted backups entirely
   - Impact: Datasets now properly inherit encryption from `slowpool/backups/raw`

## Files Changed

- `ansible/roles/backups-zfs-server/templates/zfs-pull-backups.py`
  - Added `ensure_parent_datasets_exist()` function
  - Removed `encryption=off` from parent dataset creation
  - Changed initial receive from `zfs receive -F -u` to `zfs receive -u`
  - Improved log messages throughout

- `ansible/roles/backups-zfs-server/tasks/main.yaml`
  - Removed "Ensure backup datasets exist" task
  - Added comment explaining dynamic dataset creation

## Current State

- ✅ Backup script deployed to belinda with fixes
- ✅ Test backup of `slowpool/shared/metrics/zfs` successful with 26 snapshots
- ✅ Datasets correctly inherit encryption from `slowpool/backups/raw`
- ⚠️ Existing host-storage backup datasets destroyed and need to be recreated
- ⚠️ Cronjob was running during troubleshooting and had to be killed

## Next Steps

1. **Test full backup workflow** with all host-storage datasets:
   ```bash
   ssh belinda "sudo /opt/zfsbackup/zfs-pull-backups --host host-storage --user zfsbackup --datasets fastpool/compositions slowpool/shared/metrics/zfs slowpool/shared/media/music slowpool/shared/media/books slowpool/shared/media/audiobooks slowpool/shared/media/podcasts slowpool/charlie/syncthing slowpool/charlie/photos"
   ```

2. **Verify encryption on created datasets**:
   ```bash
   ssh belinda "zfs get encryption,encryptionroot -r slowpool/backups/raw/host-storage"
   ```

3. **Monitor first automatic cronjob run** to ensure it completes successfully

4. **Update other backup servers** (if any) with the fixed script

## Notes

- **ZFS Encryption Inheritance**: Child datasets inherit encryption from parent by default at creation time. `encryption` property is readonly after creation.

- **The `-F` Flag Gotcha**: Using `-F` on `zfs receive` for initial syncs causes "cannot overwrite encrypted with unencrypted" errors when there's an encryption mismatch. Only use `-F` for incremental receives where dataset already exists.

- **Cronjob Timing**: Belinda runs backup cronjobs that can interfere with manual testing. Check for running jobs with `ps aux | grep zfs-pull-backups` before manual runs.

- **Dataset Destruction**: Had to destroy `slowpool/backups/raw/host-storage` multiple times during testing. Some receives got stuck in D state and required killing processes.

- **Comment in Ansible Role**: The comment about "encryption=off" in `backups-zfs-server/tasks/main.yaml` line 108 is now **incorrect** - it should be updated to reflect that datasets inherit encryption naturally.

## Commits

- `5d1ac07c` - fix: auto-create missing parent datasets in ZFS backup script
- `1e86f450` - style: improve incremental backup log message clarity
- `f3040bc7` - style: enhance incremental sync log messages
- `0aae5559` - fix: allow encrypted ZFS backups via inheritance
