# ZFS Snapshot Report Tool and Critical Prune Bug Fix

**Session Overview**: Created a user-friendly ZFS snapshot reporting tool and fixed a critical regex bug in the prune script that was preventing snapshots from being pruned. Also enhanced the policy inheritance system to support child datasets.

## What Was Done

- **Created ZFS snapshot report script** (`ansible/roles/system-zfs-policy/templates/zfs-snapshot-report.py.j2`):
  - User-friendly tool to view snapshot counts across all datasets
  - Groups snapshots by type (hourly/daily/monthly/yearly)
  - Shows current count vs. retention limit (e.g., "24/36" means 24 snapshots with 36 max retention)
  - Displays policy name for each dataset (none/low/high/critical)
  - Supports `--json` output for programmatic use and machine parsing
  - Supports `--debug` flag to show underlying ZFS commands being executed
  - Runnable by any user (no root required, read-only operations)

- **Deployed report script via Ansible** (`ansible/roles/system-zfs-policy/tasks/main.yaml`):
  - Script deployed to `/opt/zfs-policy/zfs-snapshot-report`
  - Created `/etc/profile.d/zfs-policy-path.sh` to add `/opt/zfs-policy` to system-wide PATH
  - Made script executable with 755 permissions
  - Available system-wide as `zfs-snapshot-report` command

- **Fixed critical regex bug in prune script** (`ansible/roles/system-zfs-policy/templates/zfs-prune.py.j2`):
  - **Bug**: Jinja2 template processing combined with Python f-strings caused regex pattern corruption
  - **Details**: Pattern `r'...\d{{4}}'` (escaped for Jinja2) became `r'...\d{4}'` after Jinja2 processing, then Python f-string interpreted `{4}` as an expression placeholder, resulting in `r'...\d4'` which never matched snapshot names
  - **Impact**: Prune script was silently failing to match ANY snapshots - nothing was being pruned
  - **Fix**: Replaced f-string with string concatenation: `pattern = r'^' + SNAPSHOT_PREFIX + r'_(\d{4}-...'`
  - This ensures the regex pattern is constructed correctly without f-string interference

- **Added policy inheritance to filter plugin** (`ansible/plugins/filters/zfs_datasets.py`):
  - Enhanced `zfs_datasets_with_config` filter to support `inherit_policy: true` attribute
  - Parent datasets can set `inherit_policy: true` to pass their importance to children
  - Child datasets inherit parent importance if they don't define their own explicit `importance`
  - Children can override inherited importance by setting their own explicit value
  - Solves the issue of child datasets having orphaned snapshots when not explicitly configured

## Key Decisions

- **Report tool design**: Created as a read-only utility that any user can run, making it easy to check snapshot status without needing root privileges or diving into raw ZFS commands.

- **PATH integration**: Added scripts directory to system-wide PATH via `/etc/profile.d/` so tools are available globally without full paths or symlinks.

- **String concatenation over f-strings for templated regex**: When templating Python code with Jinja2, f-strings with curly braces create escaping nightmares. String concatenation is more verbose but completely avoids the issue.

- **Policy inheritance design**: Child datasets must still be explicitly listed in host configuration (even as empty `{}`) to be managed by the prune script. The `inherit_policy` feature only handles passing down the importance value, not automatic discovery of children.

## Files Changed

**New files**:
- `ansible/roles/system-zfs-policy/templates/zfs-snapshot-report.py.j2` (184 lines)

**Modified files**:
- `ansible/roles/system-zfs-policy/templates/zfs-prune.py.j2` - Fixed regex f-string bug
- `ansible/roles/system-zfs-policy/tasks/main.yaml` - Added deployment tasks for report script and PATH configuration
- `ansible/plugins/filters/zfs_datasets.py` - Added inheritance support to filter

## Current State

- ZFS snapshot report tool is complete and ready for deployment
- Critical prune bug is fixed - snapshots will now be properly pruned according to policy
- Policy inheritance is functional for passing importance down to child datasets
- All changes are uncommitted in git (3 modified files, 1 new file)
- Working directory shows modified state for the snapshot policy role and filter plugin

## Next Steps

1. **Commit these changes**:
   - Group the bug fix and new features into logical commits
   - Consider separate commits for: bug fix, report tool, policy inheritance
   - Use descriptive commit messages explaining the impact

2. **Test the report tool**:
   - Run `zfs-snapshot-report` on a host with diverse datasets
   - Verify the count/limit display is accurate
   - Test `--json` output format for validity
   - Confirm `--debug` shows expected ZFS commands

3. **Test the prune fix**:
   - CRITICAL: Verify the prune script now correctly identifies snapshots
   - Run manually with old snapshots to confirm deletion works
   - Monitor first automated prune run closely
   - Check logs for proper snapshot matching and deletion

4. **Test policy inheritance**:
   - Configure a parent dataset with `inherit_policy: true` and `importance: high`
   - Add child datasets without explicit importance
   - Verify children inherit the parent's importance value
   - Test override by setting explicit importance on a child

5. **Deploy to production**:
   - Roll out to test host first
   - Verify prune script is now functional (this was completely broken before)
   - Monitor snapshot counts decrease appropriately
   - Watch for any unexpected deletions

6. **Documentation**:
   - Update role README with report tool usage examples
   - Document the policy inheritance feature and its limitations
   - Add troubleshooting section about the child dataset requirement

## Notes

- **Jinja2 + f-string escaping gotcha**: This bug demonstrates a subtle interaction between Jinja2 template processing and Python f-strings. When Jinja2 processes `{{4}}`, it outputs `{4}`. When Python then processes that as an f-string, it tries to evaluate `{4}` as an expression. The fix is to avoid f-strings entirely when the string contains regex patterns with curly braces.

- **Prune script was completely non-functional**: This bug meant the prune script has never successfully pruned any snapshots since it was created. All snapshot retention was effectively infinite. This is a critical fix that should be deployed urgently.

- **Policy inheritance limitations**: The filter plugin processes datasets defined in host configuration. It cannot automatically discover ZFS child datasets that aren't in the config. This means child datasets must be explicitly listed (even if just as `child_name: {}`) to be managed. The inheritance feature just saves repeating the importance value.

- **Report tool output format**: The "count/limit" format makes it easy to see at a glance whether datasets are approaching their retention limits. A count of "36/36" would indicate the dataset is at maximum retention and old snapshots are being pruned.

- **PATH configuration**: Using `/etc/profile.d/` for PATH additions is the standard Linux approach. Scripts there are sourced by login shells automatically, making tools available to all users without modifying individual shell configs.

## Code Snippets

**Report tool output format**:
```
Dataset: tank/photos (Policy: critical)
  Hourly:   24/720
  Daily:    30/365
  Monthly:  12/120
  Yearly:   1/240

Dataset: tank/downloads (Policy: none)
  No snapshots (none policy)
```

**Regex bug fix**:
```python
# Before (broken):
SNAPSHOT_PATTERN = re.compile(rf'^{SNAPSHOT_PREFIX}_(\d{{4}}-\d{{2}}-\d{{2}}T\d{{2}}:\d{{2}}:\d{{2}})$')
# After Jinja2: rf'^{SNAPSHOT_PREFIX}_(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})$'
# After f-string: r'^autosnap_(\d4-\d2-\d2T\d2:\d2:\d2)$'  # BROKEN!

# After (fixed):
pattern = r'^' + SNAPSHOT_PREFIX + r'_(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})$'
SNAPSHOT_PATTERN = re.compile(pattern)
# No f-string, no problem with curly braces
```

**Policy inheritance in filter plugin**:
```python
def zfs_datasets_with_config(zfs_config):
    datasets = []
    for pool_name, pool_config in zfs_config.get('pools', {}).items():
        # Process datasets with inheritance
        datasets.extend(_process_datasets(pool_name, pool_config.get('datasets', {}), parent_importance=None))
    return datasets

def _process_datasets(pool_name, datasets_config, parent_path='', parent_importance=None):
    # If parent has inherit_policy=true, pass its importance to children
    if parent_config.get('inherit_policy', False):
        importance_to_inherit = parent_config.get('config', {}).get('properties', {}).get('importance')

    # Child inherits if it doesn't have explicit importance
    if importance_to_inherit and 'importance' not in child_properties:
        child_properties['importance'] = importance_to_inherit
```

**PATH configuration** (`/etc/profile.d/zfs-policy-path.sh`):
```bash
# Add ZFS policy tools to PATH
export PATH="/opt/zfs-policy:$PATH"
```
