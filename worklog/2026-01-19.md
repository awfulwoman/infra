# Work Log - 2026-01-19

## Session Overview

Completed migration from NetworkManager/nmcli to netplan for network configuration across all Ubuntu servers. Implemented unified role supporting both static and DHCP modes with automatic detection, tested on belinda and dns hosts, and removed legacy unused roles.

## What Was Done

### Network Configuration Migration (Issue #83)

- **Created `network-netplan` role** - Unified role for managing primary network interface configuration
  - Auto-detects DHCP vs static mode based on `host_ipv4` variable presence
  - Supports both static IP and DHCP configurations via single template
  - Uses networkd renderer (matches existing virtual-hetzner pattern)
  - Disables cloud-init network management to prevent conflicts
  - Removes cloud-init's netplan configuration file

- **Updated all Ubuntu host configurations** (7 hosts total)
  - Added `host_primary_interface` variable to all hosts
  - Added `host_ipv4_subnet: 24` to static IP hosts
  - Excluded pikvm (runs Arch Linux/PiKVM OS, not Ubuntu)
  - Static hosts: host-storage, belinda, host-homeassistant, host-backups, router
  - DHCP hosts: dns, host-albion

- **Updated playbooks** - Added network-netplan role to 7 bare-metal playbooks
  - Positioned after bootstrap-ubuntu-server, before other services
  - Playbooks: belinda, dns, host-albion, host-backups, host-homeassistant, host-storage, router

- **Updated bootstrap role** - Added `netplan.io` package to bootstrap-ubuntu-server for early availability

- **Testing completed successfully**
  - **belinda (static)**: 192.168.1.150/24 - Clean single IP, no DHCP conflicts
  - **dns (DHCP)**: 192.168.1.2/24 - Proper DHCP acquisition, working routing

- **Removed legacy roles**
  - Deleted `network-ip-address-static` (unused)
  - Deleted `network-ip-address-dhcp` (unused)
  - Kept `network-ip-address-forwarding` (active on host-albion for IPv4 routing)

- **Documentation updated** - CLAUDE.md now documents network-netplan role

## Key Decisions

### Mode Auto-Detection Logic

**Decision**: Use `host_ipv4 | default('', true)` for DHCP vs static detection

**Rationale**: YAML empty values (`host_ipv4:`) become `None` in Jinja2, not empty strings. Simple string comparisons like `!= ''` fail. The `default('', true)` filter with truthiness test correctly handles both undefined and empty values.

**Result**: Static mode when `host_ipv4` has a value, DHCP mode otherwise.

### Cloud-Init Handling

**Decision**: Explicitly disable cloud-init network management and remove its netplan config

**Rationale**: Cloud-init's default netplan config enables DHCP. Without disabling it, both configs merge, resulting in interfaces with multiple IPs (both static and DHCP).

**Implementation**:
- Creates `/etc/cloud/cloud.cfg.d/99-disable-network-config.cfg`
- Removes `/etc/netplan/50-cloud-init.yaml`

### Variable Naming

**Decision**: Use `host_primary_interface` instead of reusing `configure_dns_linkdevice_physical`

**Rationale**: Cleaner separation of concerns. Network configuration uses dedicated variables, DNS registration uses its own. Avoids confusion between different purposes.

### Single Unified Role vs Separate Roles

**Decision**: Create one `network-netplan` role with conditional logic instead of separate static/DHCP roles

**Rationale**: Simpler to maintain, matches the pattern used in virtual-hetzner, template logic is straightforward enough not to warrant splitting.

## Files Changed

### New Files
- `ansible/roles/network-netplan/defaults/main.yaml`
- `ansible/roles/network-netplan/tasks/main.yaml`
- `ansible/roles/network-netplan/handlers/main.yaml`
- `ansible/roles/network-netplan/templates/50-primary-interface.yaml.j2`
- `ansible/roles/network-netplan/README.md`

### Modified Files

**Host Variables (8 files)**:
- `ansible/inventory/host_vars/belinda/core.yaml`
- `ansible/inventory/host_vars/dns/core.yaml`
- `ansible/inventory/host_vars/host-albion/core.yaml`
- `ansible/inventory/host_vars/host-backups/core.yaml`
- `ansible/inventory/host_vars/host-homeassistant/core.yaml`
- `ansible/inventory/host_vars/host-storage/core.yaml`
- `ansible/inventory/host_vars/router/core.yaml`

**Playbooks (7 files)**:
- `ansible/playbooks/baremetal/belinda/core.yaml`
- `ansible/playbooks/baremetal/dns/core.yaml`
- `ansible/playbooks/baremetal/host-albion/core.yaml`
- `ansible/playbooks/baremetal/host-backups/core.yaml`
- `ansible/playbooks/baremetal/host-homeassistant/core.yaml`
- `ansible/playbooks/baremetal/host-storage/core.yaml`
- `ansible/playbooks/baremetal/router/core.yaml`

**Roles**:
- `ansible/roles/bootstrap-ubuntu-server/defaults/main.yaml`

**Documentation**:
- `CLAUDE.md`

### Deleted Files
- `ansible/roles/network-ip-address-dhcp/` (entire directory)
- `ansible/roles/network-ip-address-static/` (entire directory)

## Current State

### Deployed & Tested
- ✅ **belinda** - Static IP (192.168.1.150/24) working perfectly
- ✅ **dns** - DHCP (192.168.1.2/24) working perfectly

### Ready for Deployment
- ⏳ **host-storage** - Static (192.168.1.116/24)
- ⏳ **host-homeassistant** - Static (192.168.1.130/24)
- ⏳ **host-backups** - Static (192.168.1.118/24)
- ⏳ **host-albion** - DHCP (UK location, Raspberry Pi)
- ⏳ **router** - Static (192.168.1.221/24, interface may need verification)

### Excluded
- ❌ **pikvm** - Runs Arch Linux (PiKVM OS), not Ubuntu, excluded from migration

### Committed
- Commit `1bb0093` - "feat: migrate network configuration from nmcli to netplan"
- 29 files changed, 137 insertions(+), 65 deletions(-)
- References issue #83

## Next Steps

### Immediate Actions

1. **Deploy to production hosts** - Roll out netplan to remaining 5 hosts
   - Recommended order: host-storage → host-homeassistant → host-backups → host-albion → router
   - Can be done with: `ansible-playbook ansible/playbooks/baremetal/<host>/core.yaml --limit <host>`

2. **Validate router interface** - Verify router host uses eth0 (assumed, not confirmed due to unreachable host)

3. **Monitor for issues** - Watch for networking problems during phased rollout

### Future Considerations

1. **Multi-interface support** - Current role only configures primary interface
   - Virtual-hetzner has floating IP example if needed
   - Would require role enhancement for bonding/VLANs

2. **IPv6 support** - Template currently IPv4-only
   - Can add dhcp6/static IPv6 if needed

3. **Custom DNS servers** - Role supports `network_netplan_nameservers` but not currently used
   - Defaults to systemd-resolved

## Notes & Gotchas

### Bug Found During Testing

**Issue**: Empty `host_ipv4:` values triggered static mode with malformed config (`- /24`)

**Root Cause**: YAML's empty value becomes `None` in Jinja2, not an empty string

**Fix**: Changed mode detection from `host_ipv4 != ''` to `host_ipv4 | default('', true)`

**Location**: `ansible/roles/network-netplan/defaults/main.yaml:20`

### Cloud-Init Conflicts

Raspberry Pi images include cloud-init with DHCP-enabled netplan configs. Without disabling cloud-init's network management, both configurations merge, causing dual IP addresses (static + DHCP).

**Solution**: Role now creates cloud-init override and removes its netplan file.

### Pre-Commit Hook Warnings

PyMarkdown warnings in CLAUDE.md are pre-existing (long lines). My changes follow the existing format. Safe to ignore during commit.

### Router Host Status

Router host (192.168.1.221) was unreachable during implementation. Interface defaulted to "eth0" based on typical naming. Should verify actual interface name before production deployment if possible.

### Network-IP-Address-Forwarding

This role was **intentionally kept** - it's for IPv4 packet forwarding via sysctl (routing/NAT), not interface configuration. Still actively used by host-albion.

## Configuration Examples

### Static IP Host (belinda)
```yaml
# host_vars/belinda/core.yaml
host_primary_interface: "eth0"
host_ipv4: 192.168.1.150
host_ipv4_subnet: 24
```

Generates:
```yaml
# /etc/netplan/50-primary-interface.yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      addresses:
        - 192.168.1.150/24
      routes:
        - to: default
          via: 192.168.1.1
```

### DHCP Host (dns)
```yaml
# host_vars/dns/core.yaml
host_primary_interface: "eth0"
host_ipv4:  # Empty = DHCP mode
```

Generates:
```yaml
# /etc/netplan/50-primary-interface.yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: true
```

## Testing Validation

Both hosts validated with:
- ✅ Netplan configuration syntax valid (`netplan get`)
- ✅ Interface configured correctly (`ip addr show`)
- ✅ Routing table correct (`ip route show`)
- ✅ SSH connectivity maintained (`ansible <host> -m ping`)
- ✅ No conflicting DHCP addresses on static hosts
- ✅ Cloud-init netplan file removed
