# Work Log - January 15, 2026

## Session: Implementing Offsite Push Replication for ZFS Backup Infrastructure

**Overview**: Completed the server-side implementation of offsite push replication for the ZFS backup infrastructure, enabling automated replication of backup datasets to offsite locations.

### What Was Done

- **Reorganized ZFS backup inventory groups** in `ansible/inventory/hosts.yaml`
  - Restructured inventory for clearer separation of concerns
  - Created three distinct groups:
    - `zfs-backup-clients`: Hosts with datasets to back up (host-storage, host-homeassistant, dns)
    - `zfs-backup-servers`: The backup server (host-backups)
    - `zfs-backup-offsite`: Offsite replication destinations (host-albion)
  - Removed `host-albion` from `zfs-backup-clients` since it now serves as an offsite destination, not a source
  - Removed deprecated `vm-awfulwoman` from inventory

- **Enhanced backups-zfs-server role with offsite push capabilities**
  - Added configuration variables in `ansible/roles/backups-zfs-server/defaults/main.yaml`:
    - `backups_zfs_server_debug: false` - Controls debug output visibility
    - `backups_zfs_server_offsite_enabled: true` - Toggles offsite replication
    - `backups_zfs_server_offsite_group: zfs-backup-offsite` - Defines target host group
    - `backups_zfs_server_offsite_cron_hour: "2"` - Schedules offsite push at 2:30 AM
    - `backups_zfs_server_offsite_cron_minute: "30"`
    - `backups_zfs_server_offsite_bwlimit: ""` - Optional bandwidth limiting for WAN transfers

- **Implemented offsite push tasks** in `ansible/roles/backups-zfs-server/tasks/main.yaml`
  - Added conditional `when: backups_zfs_server_debug` to existing debug tasks
  - Built `offsite_datasets` list using the `zfs_offsite_datasets` filter plugin (from commit `381f17d1`)
  - Added debug output for offsite datasets (when debug enabled)
  - Created cron job that invokes `zfs-push-backups` script to push snapshots to each offsite host

- **Committed changes** (commit `c494f722`)
  - Pushed to `origin/main`
  - Clean commit with no pre-commit hook issues

### Key Decisions

- **Scheduled offsite push for 2:30 AM**: Ensures offsite replication runs after client-to-server pull jobs complete (which run at various hours throughout the day)
- **Reused existing zfs-push-backups script**: Leveraged the same script used for initial backups, maintaining consistency in the codebase
- **Made bandwidth limiting optional**: Defaults to no limit, but can be configured for WAN-friendly transfers if needed
- **Separated offsite hosts into dedicated inventory group**: Provides clear organizational boundary between backup clients, backup servers, and offsite destinations

### Files Changed

- `ansible/inventory/hosts.yaml` - Reorganized ZFS backup inventory groups
- `ansible/roles/backups-zfs-server/defaults/main.yaml` - Added offsite replication configuration
- `ansible/roles/backups-zfs-server/tasks/main.yaml` - Implemented offsite push tasks

### Current State

The ZFS backup infrastructure now supports the full 3-2-1 backup strategy:

1. **3 copies**: Original data + local backup server + offsite backup
2. **2 different media**: Local ZFS pools + remote ZFS pools
3. **1 offsite**: Automated push to offsite destinations

Server-side implementation is complete:
- Backup server pulls from clients (existing functionality)
- Backup server identifies datasets marked for offsite replication
- Backup server pushes to offsite hosts on schedule (new functionality)
- All changes committed and pushed to main branch

### Next Steps

- **Configure the `backups-zfs-offsite` role** for receiving hosts (host-albion)
  - Define what permissions and ZFS configurations are needed on the receiving side
  - Ensure proper authentication for push operations
  - Configure retention policies for offsite datasets

- **Test the offsite push workflow**
  - Verify `zfs_offsite_datasets` filter correctly identifies datasets
  - Confirm cron job executes on schedule
  - Validate snapshots are successfully replicated to host-albion
  - Check bandwidth limiting functionality if configured

- **Document the complete backup architecture**
  - Update architecture documentation with offsite replication flow
  - Document how to mark datasets for offsite replication in host_vars
  - Add runbook for troubleshooting offsite replication issues

### Notes

- The `zfs_offsite_datasets` filter plugin (from `ansible/plugins/filters/zfs_datasets.py`) is critical to this implementation - it extracts datasets marked with offsite flags from the declarative `zfs:` host variable structure
- Offsite push relies on the same `zfs-push-backups` script used for client-to-server replication, ensuring consistency
- The 2:30 AM schedule assumes client pull jobs complete by then; monitor to ensure no overlap
- Host-albion was removed from `zfs-backup-clients` but still needs configuration as an offsite destination in the next phase
- Debug mode can be enabled by setting `backups_zfs_server_debug: true` to troubleshoot offsite dataset selection
