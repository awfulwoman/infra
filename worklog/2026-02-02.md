# Work Log - 2026-02-02

## Session Overview

Migrated Vagrant VM provisioning from inline shell scripts to Ansible roles and fixed all provisioning errors to achieve successful end-to-end execution.

## What Was Done

### Major Work

- **Created three new Ansible roles** to replace shell scripts:
  - `system-nvm`: Installs NVM v0.40.1 and Node.js LTS, sets default version
  - `system-claude`: Installs Claude CLI, adds `~/.local/bin` to PATH
  - `bootstrap-ubuntu-vagrant-wrapper`: Extends bootstrap with SSH agent auto-start, SSH config for local networks, workspace path auto-cd

- **Enhanced zfs-snapshot-report** to show unmanaged datasets:
  - Added `get_all_system_datasets()` and `get_unmanaged_datasets()` functions
  - Report now has two sections: managed (with policy) and unmanaged (no policy)
  - Unmanaged section shows total snapshots + autosnap count

- **Fixed Vagrant provisioning configuration**:
  - Switched from `ansible` provisioner to shell provisioner with explicit control
  - Set `ANSIBLE_ROLES_PATH` environment variable to ensure local roles are found
  - Configured `ansible_connection: local` and `ansible_user: vagrant` in inventory
  - Added `vault_server_username` to vagrant group_vars (copied from infra group)
  - Overrode `environment_config` to empty dict for Vagrant (doesn't need production vars)

### Tasks Within bootstrap-ubuntu-vagrant-wrapper

Created three feature groups from original scripts:

1. **SSH Agent Auto-Start** (`ssh_agent.sh`):
   - Adds block to `.bashrc` to start ssh-agent on first login
   - Prompts to add SSH key
   - Creates marker file after first run

2. **SSH Config** (`ssh_config.sh`):
   - Configures SSH for local networks (192.168.0.*, 100.*.*.*)
   - Disables strict host key checking for dev environments
   - Uses blockinfile for idempotency

3. **Workspace Path Auto-CD** (`user_switch_path.sh`):
   - Adds `cd` command to `.bashrc` on login
   - Only runs if `bootstrap_ubuntu_workspace_path` is non-empty

## Key Decisions

- **Shell provisioner over ansible_local**: Using shell provisioner with explicit `ANSIBLE_ROLES_PATH` proved more reliable than trying to configure ansible_local's complex path resolution
- **Copied vault vars**: Rather than hardcode "vagrant" username, copied `vault_server_username` from infra group to maintain consistency
- **Minimal environment_config**: Vagrant VMs don't need production environment variables, so overrode with empty dict
- **Role consolidation**: Combined SSH agent, SSH config, and workspace cd into single bootstrap role rather than separate roles (they're tightly coupled to Vagrant use case)

## Files Changed

### Created
- `ansible/roles/system-nvm/tasks/main.yaml`
- `ansible/roles/system-nvm/defaults/main.yaml`
- `ansible/roles/system-claude/tasks/main.yaml`
- `ansible/roles/system-claude/defaults/main.yaml`
- `ansible/roles/bootstrap-ubuntu-vagrant-wrapper/tasks/main.yaml`
- `ansible/roles/bootstrap-ubuntu-vagrant-wrapper/defaults/main.yaml`
- `ansible/roles/bootstrap-ubuntu-vagrant-wrapper/README.md`
- `ansible/playbooks/virtual/vagrant-wrapper/core.yaml`
- `ansible/inventory/group_vars/vagrant/core.yaml`
- `ansible/inventory/host_vars/vagrant-wrapper/core.yaml`

### Modified
- `Vagrantfile`: Replaced `ansible` provisioner with shell provisioners
- `ansible/roles/system-zfs-policy/templates/zfs-snapshot-report.py.j2`: Added unmanaged dataset detection
- `ansible/inventory/group_vars/vagrant/core.yaml`: Added vault vars, SSH config overrides, empty environment_config

## Current State

âœ… **Working**: Vagrant provisioning successfully completes
- 41 tasks OK, 8 changed, 0 failed
- NVM + Node.js LTS installed
- Claude CLI installed
- SSH agent configured
- SSH config for local networks configured
- All bootstrap tasks complete

## Next Steps

1. **Test the VM**: SSH into Vagrant VM and verify:
   - NVM is available and Node.js works
   - Claude CLI is available (`claude --version`)
   - SSH config works for local network access
   - Workspace path cd on login works

2. **Clean up old scripts**: Consider removing original shell scripts from `scripts/vagrant/` since they're now replaced by roles:
   - `install_nvm.sh`
   - `install_claude.sh`
   - `ssh_agent.sh`
   - `ssh_config.sh`
   - `user_switch_path.sh`

3. **Documentation**: Update Vagrant-related docs if they exist to reflect Ansible-based provisioning

## Notes

### Provisioning Path Resolution Issues

The ansible_local provisioner had several issues with path resolution:
- Vagrant mounts project to custom path (`/workspace-infra`), not `/vagrant`
- `provisioning_path` option exists but roles_path still didn't work reliably
- `raw_arguments` with `--roles-path` isn't a valid ansible-playbook argument
- Solution: Shell provisioner with `export ANSIBLE_ROLES_PATH=...` before running ansible-playbook

### Variable Undefined Errors

Hit multiple undefined variable errors during provisioning:
- `config_system_locale` / `config_system_language` (inherited from production bootstrap role)
- `vault_server_username` (used in SSH config and sudoers)
- Production environment variables (ansible_path, home_repo_dir, etc.)

Solution was to override at vagrant group_vars level, not fix in role defaults.

### YAML Pre-commit Hook

The `check-yaml` pre-commit hook fails on Ansible Vault `!vault` tags. This is expected - instructions say to ignore these errors. Vault-encrypted vars work fine in Ansible.

## Commits Made

1. `feat(zfs): add unmanaged datasets to snapshot report` - b6b79895
2. `refactor(vagrant): migrate shell provisioning to Ansible roles` - c1129bf4
3. `chore: work in progress` - 1969dbce (misc changes: vagrant inventory, github2karakeep composition, ansible.cfg fix)
4. `fix(vagrant): correct Ansible provisioning configuration` - 1debcbaa
