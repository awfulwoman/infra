# Work Log - 2026-02-03

## Session Overview
Fixed critical SSH restart timeout issue affecting first-time host provisioning, and improved system-promtail role idempotency.

## What Was Done

### 1. Fixed SSH Restart Timeout on First Provision
- **Problem**: `system-security` role's SSH restart handler caused daemon-reload timeout when interrupting active Ansible connection during initial provisioning
- **Solution**: Implemented async restart + connection reset + wait pattern
- **Impact**: Eliminates provisioning failures that required manual playbook restart
- **Files**: `ansible/roles/system-security/handlers/main.yaml`

### 2. Made system-promtail Role Idempotent
- **Problem**: Role downloaded and extracted Promtail binary on every run (3 tasks always changed)
- **Solution**: Added version checking logic to skip installation when binary exists with correct version
- **Testing**: Created temporary test playbook against `dns` host, confirmed 0 changes on reruns
- **Files**: `ansible/roles/system-promtail/tasks/main.yaml`

### 3. Infrastructure Updates
- Updated Hetzner server size: cx23 → cax21 (ARM architecture)
- Added UDP port 53 outbound firewall rule for DNS resolution
- Hardcoded IP for vm-awfulwoman-hetzner instead of variable reference
- **Files**:
  - `ansible/roles/infra-public-resources/defaults/main/hetzner.yaml`
  - `ansible/inventory/host_vars/vm-awfulwoman-hetzner/core.yaml`

## Key Decisions

### SSH Restart Handler Pattern
Used `listen:` directive with three sequential handlers:
1. Async restart (async: 10, poll: 0)
2. Connection reset (`meta: reset_connection`)
3. Wait for SSH (`wait_for_connection` with 60s timeout)

This pattern allows existing `notify: Restart SSH` calls to work unchanged while properly handling connection interruption.

### Promtail Version Checking
Checks both file existence and version match using `promtail --version`. Installation block only runs when `promtail_needs_install` fact is true. Prevents wasteful downloads on every playbook run.

## Files Changed

```
ansible/roles/system-security/handlers/main.yaml          # SSH restart fix
ansible/roles/system-promtail/tasks/main.yaml             # Idempotency fix
ansible/roles/infra-public-resources/defaults/main/hetzner.yaml  # Server config
ansible/inventory/host_vars/vm-awfulwoman-hetzner/core.yaml      # IP hardcode
```

## Commits

1. `0c75f690` - fix(system-security): prevent SSH restart timeout on first provision
2. `178d8836` - chore(infra): update Hetzner server size and firewall rules
3. `56f1e080` - chore(vm-awfulwoman-hetzner): use direct IP for ansible_host
4. `bd7e2c31` - fix(system-promtail): make role idempotent with version checking

## Testing

- **SSH restart fix**: Tested successfully on vm-awfulwoman-hetzner during full provisioning
  - Handler executed without timeout
  - Connection reset and wait worked correctly
  - Playbook continued successfully (178 tasks ok, 61 changed)

- **Promtail idempotency**: Tested on `dns` host
  - First run after fix: 0 changed tasks, 5 skipped
  - Second run: 0 changed tasks, 5 skipped (confirmed idempotent)

## Known Issues Discovered

### fail2ban Reload Timeout
During vm-awfulwoman-hetzner testing, discovered fail2ban reload handler has same timeout issue as SSH restart:
```
RUNNING HANDLER [system-security : Reload fail2ban]
fatal: Connection timed out
```

**Location**: `ansible/roles/system-security/handlers/main.yaml:19`

**Should Apply**: Same async + connection reset pattern used for SSH restart

## Current State

- Branch is 6 commits ahead of origin/main
- All changes committed but not pushed
- SSH restart issue: **RESOLVED** ✅
- Promtail idempotency: **RESOLVED** ✅
- fail2ban reload issue: **IDENTIFIED** but not fixed

## Next Steps

1. **Fix fail2ban reload handler** - Apply same async pattern as SSH restart
2. **Review other roles** for similar idempotency issues (check for unconditional downloads/extracts)
3. **Consider GitHub issues** from open issue review:
   - #135: Create systemd-based Docker image pruning (well-defined, good first implementation)
   - #146: Set up Pushover as Grafana alert method
   - #153: Design consistent device naming scheme
4. **Push commits** when ready to sync with remote

## Notes

- `bootstrap-ubuntu-server` "Ensure 127.0.1.1 is correct" task IS necessary - prevents `sudo: unable to resolve host` warnings
- Hetzner firewall config allows SSH (port 22) from 0.0.0.0/0 and ::/0
- vm-awfulwoman-hetzner is now provisioned and accessible at 188.245.37.81

---

# Evening Session - 2026-02-04 22:33

## Session Overview
Fixed fail2ban handler issues, improved Vagrant provisioning, and refactored vagrant-wrapper role for better SSH config management and agent handling.

## What Was Done

### 1. Fixed fail2ban Handler Issues (Complete)
- **Problem 1**: fail2ban reload timing out after SSH restart (similar to SSH timeout issue)
- **Solution 1**: Changed `reload` to `restart` for more reliable service management
- **Problem 2**: "Interactive authentication required" error on fresh machines
- **Solution 2**: Added `become: true` for privilege escalation
- **Impact**: fail2ban handler now works reliably on fresh provisioning
- **Files**: `ansible/roles/system-security/handlers/main.yaml`

### 2. Improved Vagrant Provisioning
- Simplified provisioning output (removed verbose echo statements)
- Added `keychain` and `pipx` packages
- Installed Ansible from official PPA for latest version
- Made apt upgrade configurable (commented out for faster dev iterations)
- Moved VAGRANT_WORKSPACE_PATH to environment variable for cleaner CLI
- **Files**: `Vagrantfile`

### 3. Refactored vagrant-wrapper SSH Configuration
- **Before**: Hardcoded network ranges (192.168.0.*, 100.*.*.*)
- **After**: Dynamic discovery from Ansible `infra` group
- SSH config now references inventory hostnames (host-homeassistant, dns, etc.)
- Auto-updates when hosts added/removed from inventory
- **Files**:
  - `ansible/roles/bootstrap-ubuntu-vagrant-wrapper/defaults/main.yaml`
  - `ansible/roles/bootstrap-ubuntu-vagrant-wrapper/tasks/main.yaml`

### 4. Fixed SSH Agent Password Prompting
- **Problem**: Script prompted for SSH key password on every new shell
- **Root Cause**: `ssh-add` ran unconditionally on every bashrc execution
- **Solution**: Replaced manual ssh-agent script with `keychain` utility
- **Benefit**: Single password prompt per boot, reuses agent across all shells
- **Files**:
  - `ansible/roles/bootstrap-ubuntu-vagrant-wrapper/defaults/main.yaml` (added keychain package)
  - `ansible/roles/bootstrap-ubuntu-vagrant-wrapper/tasks/main.yaml` (simplified to single line)

## Key Decisions

### fail2ban: Restart vs Reload
Used `restart` instead of `reload` for fail2ban handler because:
- More reliable than reload (clean service restart)
- No systemd timeout issues
- Brief interruption acceptable during provisioning
- Simpler than async/retry patterns

### SSH Config: Group-based vs Network Ranges
Switched from network ranges to Ansible group references:
- Maintainable via inventory, not hardcoded values
- Clear host names instead of IP patterns
- Auto-updates with infrastructure changes
- Enables `ssh host-homeassistant` directly from vagrant

### SSH Agent: keychain vs Manual Script
Replaced 8-line conditional script with keychain:
- Industry-standard tool designed for this use case
- Persistent agent across sessions (survives tmux, multiple terminals)
- Single password prompt per boot
- Cleaner, more maintainable code

## Files Changed

```
# System Security
ansible/roles/system-security/handlers/main.yaml                    # fail2ban fixes

# Vagrant Core
Vagrantfile                                                          # Provisioning improvements

# Vagrant Wrapper Role
ansible/roles/bootstrap-ubuntu-vagrant-wrapper/defaults/main.yaml   # SSH config + keychain
ansible/roles/bootstrap-ubuntu-vagrant-wrapper/tasks/main.yaml      # SSH config + keychain

# Inventory
ansible/inventory/group_vars/all.yaml                               # Vagrant key placeholders
```

## Commits (7 new since morning session)

1. `a65d1f4d` - fix(system-security): use restart instead of reload for fail2ban
2. `de7242d2` - refactor(vagrant): simplify provisioning and use Ansible PPA
3. `9c493d19` - chore(vagrant): re-enable apt upgrade during provisioning
4. `0eb47fd6` - fix(system-security): add become to fail2ban restart handler
5. `a8d479f1` - chore(vagrant): improve workspace config and add key placeholders
6. `6a1d11e9` - refactor(vagrant-wrapper): use infra group for SSH config
7. `094859b5` - fix(vagrant-wrapper): use keychain for SSH agent management

## Current State

- Branch is **13 commits** ahead of origin/main (6 from morning + 7 from evening)
- All changes committed but **not pushed**
- SSH restart issue: **RESOLVED** ✅
- Promtail idempotency: **RESOLVED** ✅
- fail2ban reload issue: **RESOLVED** ✅ (both timeout and permission)
- SSH agent prompting: **RESOLVED** ✅
- Vagrant SSH config: **IMPROVED** ✅

## Next Steps

1. **Push commits** to origin/main (13 commits ready)
2. **Test vagrant wrapper** on fresh vagrant up to verify keychain + SSH config changes
3. **Consider GitHub issues** from open issue review:
   - #135: Create systemd-based Docker image pruning (well-defined, good first implementation)
   - #146: Set up Pushover as Grafana alert method
   - #153: Design consistent device naming scheme
4. **Review other roles** for idempotency issues (look for unconditional downloads/extracts)

## Notes

- keychain stores agent info in `~/.keychain/` directory
- SSH config generated in `~/.ssh/config` under "Vagrant infra hosts config" marker
- Removed DEBUG task from vagrant-wrapper (was line 141-143)
- infra group has 9 hosts: host-homeassistant, host-backups, host-storage, vm-awfulwoman-hetzner, host-albion, dns, testrouter, pikvm, belinda
