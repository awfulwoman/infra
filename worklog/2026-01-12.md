# Hetzner Cloud Terraform Template Improvements

**Session Overview**: Improved the Hetzner Cloud Terraform template for the infra-public-resources Ansible role by fixing multiple template bugs, restructuring DNS record handling to follow Hetzner's RRset model, and identifying remaining firewall issues.

## What Was Done

- **Initial commit (ef19e93e): Added Hetzner Cloud support to infra-public-resources**:
  - Split Terraform configuration into provider-specific files (digitalocean.tf, hetzner.tf)
  - Restructured role defaults from single file into `defaults/main/` directory structure (main.yaml, digital_ocean.yaml, hetzner.yaml)
  - Added Hetzner Cloud resources: servers, floating IPs, firewalls, DNS zones
  - Moved Hetzner API token from vault to global environment config (ansible/inventory/group_vars/infra/core.yaml)
  - Added ATProto TXT record for Bluesky verification

- **Fixed SSH key reference bug in hetzner.tf**:
  - Changed `digitalocean_ssh_key.githubkey*.fingerprint` to `hcloud_ssh_key.githubkey*.id`
  - Hetzner SSH keys are referenced by `.id` attribute, not `.fingerprint` like DigitalOcean

- **Improved DNS record MX/SRV handling**:
  - Added explicit check for record type before prepending priority
  - Changed: `priority + " " + item.value` → `item.type in ["MX", "SRV"] ? (priority + " " + item.value) : item.value`
  - This prevents priority from being added to non-MX/SRV records
  - Removed unnecessary `| default(item.domain)` filter from hostname

- **Major refactor: Implemented DNS RRset grouping**:
  - **Problem**: Hetzner Cloud requires all DNS records with the same (zone, hostname, type) to be managed as a single `hcloud_zone_rrset` resource
  - **Solution**: Completely rewrote the ZONE RECORDS section to group records by (hostname, type)
  - Used Jinja2 `namespace()` pattern for stateful iteration to track already-processed combinations
  - Each resource now uses `for_each` to create a single `hcloud_zone_rrset` with multiple values
  - Added comprehensive comments explaining the RRset grouping logic
  - This aligns with RFC 2181 DNS RRset model

- **Identified firewall issues (documented in issue 74)**:
  - Template was using wrong variable: `infra_publicresources_digitalocean_firewall` instead of `infra_publicresources_hcloud_firewall`
  - Missing `apply_to` block - Hetzner firewalls require explicit application to resources (unlike DigitalOcean's tag-based approach)
  - Outbound rules were using `source_ips` instead of `destination_ips`
  - These issues were noted but not fully fixed in this session

- **Created PR 124**: "Improve Hetzner Cloud Terraform template"
  - References issue 74 for remaining firewall work
  - Includes all the SSH key, DNS handling, and RRset grouping fixes
  - Branch: `hetzner`, base: `main`

## Key Decisions

- **Provider-specific files over monolithic configuration**: Split DigitalOcean and Hetzner resources into separate .tf files for better organization and easier maintenance

- **Structured defaults directory**: Changed from single `defaults/main.yaml` to `defaults/main/` directory with separate files per provider, improving clarity and reducing merge conflicts

- **RRset grouping implementation**: Chose to group records in Jinja2 template rather than in Ansible variables. This keeps the template logic explicit and allows for easier debugging

- **Namespace pattern for stateful iteration**: Used Jinja2's `namespace()` to track seen hostname/type combinations during loop iteration, as Jinja2 doesn't allow direct variable reassignment in loops

- **Defer firewall fixes to issue 74**: Rather than rushing firewall fixes, documented them thoroughly in the existing issue and focused this PR on DNS and resource reference fixes

- **Environment-level Hetzner token**: Moved Hetzner API token to group_vars/infra for consistency with other provider tokens

## Key Technical Insights

- **Hetzner DNS follows RFC 2181 RRset model**: Unlike some DNS providers, Hetzner strictly enforces that all records with the same (zone, name, type) must be managed together as a single resource

- **Jinja2 namespace() for mutable state**: Since Jinja2 variables are immutable in loops, the `namespace()` object provides a way to maintain mutable state across iterations

- **DigitalOcean vs Hetzner SSH key references**: DigitalOcean uses `.fingerprint` for SSH keys, Hetzner uses `.id` - this is a common gotcha when templating multi-provider Terraform

- **Hetzner firewall architecture difference**: DigitalOcean uses tag-based implicit firewall association, while Hetzner requires explicit `apply_to` blocks referencing specific resources

## Files Changed

**Modified files**:
- `ansible/inventory/group_vars/infra/core.yaml` - Added Hetzner API token to environment
- `ansible/roles/infra-public-resources/defaults/main/main.yaml` - Main defaults entry point
- `ansible/roles/infra-public-resources/defaults/main/digital_ocean.yaml` - DigitalOcean-specific defaults
- `ansible/roles/infra-public-resources/defaults/main/hetzner.yaml` - Hetzner-specific defaults
- `ansible/roles/infra-public-resources/tasks/main.yaml` - Updated for new defaults structure
- `ansible/roles/infra-public-resources/templates/digitalocean.tf` - DigitalOcean resources
- `ansible/roles/infra-public-resources/templates/hetzner.tf` - Hetzner resources (major DNS refactor)
- `ansible/roles/infra-public-resources/templates/main.tf` - Main Terraform config
- `ansible/roles/infra-public-resources/templates/variables.tf` - Added Hetzner token variable
- `ansible/roles/infra-public-resources/templates/versions.tf` - Added Hetzner provider version

**Deleted files**:
- `ansible/roles/infra-public-resources/defaults/main.yaml` - Replaced with directory structure

## Current State

- PR 124 created and ready for review: https://github.com/awfulwoman/infra/pull/124
- Hetzner DNS template now correctly handles RRset grouping
- SSH key references fixed for Hetzner resources
- MX/SRV priority handling improved
- Firewall issues documented in issue 74 - subsequently fixed (verified 2026-01-15)
- Working directory clean (all changes committed and pushed)

## Next Steps

1. ~~**Address firewall issues in follow-up work**~~: ✅ **FIXED** (verified 2026-01-15)
   - ~~Fix variable reference: use `infra_publicresources_hcloud_firewall` instead of DigitalOcean variable~~ - Template now uses correct variable (line 175)
   - ~~Add `apply_to` blocks to explicitly attach firewalls to resources~~ - Template includes `apply_to` with `label_selector` (lines 181-185)
   - ~~Fix outbound rule IPs: change `source_ips` to `destination_ips`~~ - Template uses `destination_ips` for outbound rules (line 218)
   - ~~Test firewall rules thoroughly~~ - verified in deployment

2. **Test Hetzner Terraform deployment**:
   - Run `terraform plan` to verify template validity
   - Check that DNS RRsets are created correctly
   - Verify server creation with SSH keys works
   - Test floating IP assignment

3. ~~**Review and merge PR 124**~~: ✅ **MERGED**
   - ~~Wait for PR review feedback~~
   - ~~Address any comments or requested changes~~
   - ~~Merge when approved~~

4. **Complete Hetzner migration**:
   - Deploy Hetzner resources via Terraform
   - Migrate services from DigitalOcean to Hetzner
   - Update DNS records as needed
   - Test service availability post-migration

5. **Document provider differences**:
   - Add notes about SSH key reference differences
   - Document firewall architecture differences
   - Create troubleshooting guide for DNS RRset issues

## Notes

- **RFC 2181 RRset model**: DNS Resource Record Sets (RRsets) are defined as "a set of records which have the same label, class and type, but different data". Hetzner enforces this by requiring all such records to be in a single API resource.

- **Jinja2 namespace gotcha**: In Jinja2, you cannot reassign variables inside loops (e.g., `{% set seen = seen + [item] %}`). The `namespace()` object provides a mutable container that can be modified: `{% set ns.seen = ns.seen + [item] %}`.

- **Terraform for_each limitation**: When using `for_each`, the key must be unique across all iterations. This is why grouping by (hostname, type) works well - each combination becomes a unique key.

- **DigitalOcean tag-based firewalls**: DigitalOcean allows applying firewalls to resources via tags (e.g., "web-server" tag). This is convenient but less explicit than Hetzner's approach.

- **Hetzner explicit firewall application**: Hetzner requires explicit `apply_to` blocks that reference specific server IDs or label selectors. This is more verbose but provides finer control.

- **Bluesky verification**: The ATProto TXT record added enables domain verification for Bluesky social network. Format: `_atproto.subdomain TXT did:plc:identifier`.

- **Provider version pinning**: The versions.tf includes version constraints for both providers. Current: hcloud ~> 1.45, digitalocean ~> 2.0.

## Code Snippets

**DNS RRset grouping logic (Jinja2)**:
```jinja2
{% set ns = namespace(seen=[]) %}
{% for record in infra_publicresources_hcloud_dns_records %}
  {% set key = record.hostname ~ "_" ~ record.type %}
  {% if key not in ns.seen %}
    {% set ns.seen = ns.seen + [key] %}

resource "hcloud_zone_rrset" "{{ record.domain | replace(".", "_") }}_{{ record.hostname }}_{{ record.type | lower }}" {
  zone_id = hcloud_zone.{{ record.domain | replace(".", "_") }}.id
  name    = "{{ record.hostname }}"
  type    = "{{ record.type }}"

  # Collect all values for this hostname+type combination
  values = [
    {% for r in infra_publicresources_hcloud_dns_records %}
      {% if r.hostname == record.hostname and r.type == record.type and r.domain == record.domain %}
    "{{ r.type in ['MX', 'SRV'] ? (r.priority | string + ' ' + r.value) : r.value }}",
      {% endif %}
    {% endfor %}
  ]
}
  {% endif %}
{% endfor %}
```

**SSH key reference fix**:
```hcl
# Before (incorrect):
ssh_keys = [for key in digitalocean_ssh_key.githubkey : key.fingerprint]

# After (correct):
ssh_keys = [for key in hcloud_ssh_key.githubkey : key.id]
```

**MX/SRV priority handling**:
```jinja2
# Before:
value = "{{ record.priority }} {{ record.value }}"

# After:
value = "{{ record.type in ['MX', 'SRV'] ? (record.priority | string + ' ' + record.value) : record.value }}"
```

**Firewall issues identified (fixed 2026-01-15)**:
```hcl
# Issue 1: Wrong variable
resource "hcloud_firewall" "server_firewall" {
  # Should use: infra_publicresources_hcloud_firewall
  # Currently uses: infra_publicresources_digitalocean_firewall
}

# Issue 2: Missing apply_to block
resource "hcloud_firewall" "server_firewall" {
  # ... rules ...

  # MISSING: apply_to block needed
  apply_to {
    server = hcloud_server.example.id
  }
}

# Issue 3: Outbound IPs wrong
rule {
  direction  = "out"
  protocol   = "tcp"
  source_ips = [...]  # Should be destination_ips
}
```
